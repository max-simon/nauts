# Specification: Command-Line Interface (`cmd/nauts/`)

**Date:** 2026-02-08  
**Status:** Current  
**Package:** `cmd/nauts`  
**Dependencies:** `auth` (config, controller, callout service)

---

## Goal

Provide a simple, consistent command-line interface for running the nauts auth callout service.

## Summary

The `nauts` CLI provides a single action that runs the auth callout service, with an optional `--enable-debug-svc` flag to also start the debug service. The command uses a shared JSON configuration file and supports an environment variable override for the config path.

---

## Scope

- Single command with flags  
- Shared configuration loading via `-c/--config` flag or `NAUTS_CONFIG` env var  
- Standard Unix exit codes (0 = success, 1 = error)  
- Signal handling for graceful shutdown  
- Optional debug service via `--enable-debug-svc`  

**Out of scope:** Interactive prompts, daemon management, systemd integration, log rotation.

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| **Single command** | Reduces confusion and keeps the operational surface minimal. |
| **Shared config file format** | Reduces duplication. The same `nauts.json` works for service and debug. |
| **Environment variable for config path** | Enables containerized deployments where config path is injected via env vars. |
| **Optional debug flag** | Keeps debug service off by default while enabling quick local inspection. |
| **Graceful shutdown on SIGINT/SIGTERM** | Production services need clean shutdown to avoid dropping in-flight auth requests. |
| **Exit code 1 for all errors** | Simple binary success/failure. Detailed errors written to stderr. |

---

## Public API

### Command

```bash
nauts [options]
```

**Purpose:** Run the NATS auth callout service. Subscribes to `$SYS.REQ.USER.AUTH` and handles authentication requests from the NATS server. Blocks until shutdown signal received. Optionally starts the debug service.

**Flags:**

| Flag | Type | Default | Required | Description |
|------|------|---------|:--------:|-------------|
| `-c`, `--config` | string | `$NAUTS_CONFIG` | ✓ | Path to configuration JSON file |
| `--enable-debug-svc` | bool | `false` | ✗ | Start the NATS auth debug service |

**Environment Variables:**
- `NAUTS_CONFIG`: Fallback for `-c/--config` flag

**Signal Handling:**
- `SIGINT` (Ctrl+C): Graceful shutdown
- `SIGTERM`: Graceful shutdown

**Graceful Shutdown Sequence:**
1. Service receives signal
2. Subscription drained (no new requests accepted)
3. In-flight requests complete
4. NATS connection closed
5. Exit with code 0

**Output:**
- Startup messages to stderr
- Auth request logs to stderr (via configured logger)
- Shutdown message on signal

**Configuration Requirements:**
The command requires the `server` section in the config file:
```json
{
  "server": {
    "natsUrl": "nats://localhost:4222",
    "natsNkey": "auth-service.nk",
    "xkeySeedFile": "xkey.seed",
    "ttl": "1h"
  }
}
```

**Examples:**
```bash
# Start service with config file
nauts -c /etc/nauts/config.json

# Start with env var config path
export NAUTS_CONFIG=/etc/nauts/config.json
nauts

# Run with debug service enabled
nauts -c config.json --enable-debug-svc
```

### Help Command

```bash
nauts help              # Print usage
nauts -h                # Print usage
nauts --help            # Print usage
```

---

## Configuration File

The command uses the same JSON configuration format. See [auth-controller-callout spec](2026-02-06-auth-controller-callout.md) for complete config reference.

**Minimal static mode example:**
```json
{
  "account": {
    "type": "static",
    "static": {
      "publicKey": "ACONFIG...",
      "privateKeyPath": "issuer.nk",
      "accounts": ["APP"]
    }
  },
  "policy": {
    "type": "file",
    "file": {
      "policiesPath": "policies.json",
      "bindingsPath": "bindings.json"
    }
  },
  "auth": {
    "file": [
      { "id": "local", "accounts": ["APP"], "userPath": "users.json" }
    ]
  }
}
```

**For service mode, add:**
```json
{
  "server": {
    "natsUrl": "nats://localhost:4222",
    "natsCredentials": "auth.creds",
    "xkeySeedFile": "xkey.seed",
    "ttl": "1h"
  }
}
```

---

## Exit Codes

| Code | Meaning |
|:----:|---------|
| 0 | Success |
| 1 | Error (all error conditions) |

Detailed error information is written to stderr.

---

## Error Handling

**All errors result in:**
1. Descriptive message written to stderr
2. Exit code 1

**Error categories:**

| Error Type | Example Message |
|-----------|-----------------|
| Missing required flag | `error: -c/--config is required` |
| Config file error | `error: loading configuration: open nauts.json: no such file or directory` |
| Validation error | `error: creating auth controller: account.static.publicKey is required` |
| Authentication error | `error: authentication failed: invalid credentials` |
| Service startup error | `error: running callout service: failed to connect to NATS` |

**No error details leaked to clients:** The auth callout service returns generic errors to NATS clients (`"authentication failed"` or `"internal error"`). Full errors are logged server-side.

---

## Testing

### Manual Testing

**Test service command:**
```bash
# Start service
nauts -c test.json &
SERVICE_PID=$!

# Test with NATS client
nats --token '{"account":"APP","token":"alice:secret"}' pub test "hello"

# Stop service
kill -TERM $SERVICE_PID
```

**Test with debug service enabled:**
```bash
nauts -c test.json --enable-debug-svc &
SERVICE_PID=$!

# Issue a debug request (see debug service spec for request payload)
nats req nauts.debug '{"user": {"id": "alice"}, "account": {"id": "APP"}}'

kill -TERM $SERVICE_PID
```

### Integration Tests

The `e2e/` tests cover CLI behavior:
- `connection_test.go`: Tests full CLI + NATS server integration
- Verifies the service command
- Tests static and operator modes

---

## Known Limitations / Future Work

- **No interactive mode:** No interactive prompts (use preconfigured providers and tokens from clients).
- **No config validation command:** No `nauts validate-config` command to check config files without running authentication.
- **No version command:** No `nauts version` to print build information.
- **No daemon management:** No built-in process management (use systemd, docker, or similar).
- **No log levels:** Logging verbosity not configurable via CLI flags (uses default logger).
- **No health check command:** No `nauts health` to check if service is responding.
- **Single config file:** Cannot merge multiple config files or override individual settings via flags.

---

## Future Enhancements

| Enhancement | Priority | Description |
|------------|:--------:|-------------|
| `validate-config` command | Medium | Validate config file without starting service |
| `version` command | Low | Print version and build information |
| `health` command | Low | Check service health via NATS connection |
| Log level flags | Low | Add `-v/--verbose` and `-q/--quiet` flags |
| Config overrides | Low | Allow flag-based override of config values (e.g., `--server.ttl=30m`) |
| Interactive auth | Low | Prompt for credentials in a future CLI command |

---

## See Also

- [Auth Controller & Callout Service Spec](2026-02-06-auth-controller-callout.md) - Configuration format and service behavior
- [System Overview](2026-02-06-system-overview.md) - Architecture and deployment modes
- [e2e/README.md](../e2e/README.md) - End-to-end testing documentation

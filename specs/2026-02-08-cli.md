# Specification: Command-Line Interface (`cmd/nauts/`)

**Date:** 2026-02-08  
**Status:** Current  
**Package:** `cmd/nauts`  
**Dependencies:** `auth` (config, controller, callout service)

---

## Goal

Provide a simple, consistent command-line interface for one-shot authentication and running the nauts auth callout service.

## Summary

The `nauts` CLI provides two subcommands: `auth` for one-shot JWT generation (useful for testing and scripting) and `serve` for running the production auth callout service. Both commands share a common configuration file format and support environment variable overrides for the config path.

---

## Scope

- Two subcommands: `auth` and `serve`  
- Shared configuration loading via `-c/--config` flag or `NAUTS_CONFIG` env var  
- Standard Unix exit codes (0 = success, 1 = error)  
- Signal handling for graceful shutdown (`serve` command)  

**Out of scope:** Interactive prompts, daemon management, systemd integration, log rotation.

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| **Two subcommands instead of separate binaries** | Simpler distribution and deployment. Users get both auth modes in one binary. |
| **Shared config file format** | Reduces duplication. The same `nauts.json` works for both CLI and service. |
| **Environment variable for config path** | Enables containerized deployments where config path is injected via env vars. |
| **JSON token format for `auth`** | Matches the auth callout protocol token format. Users can test the exact tokens their applications will send. |
| **Ephemeral user key generation** | `auth` command generates a temporary nkey if none provided, simplifying testing. |
| **Graceful shutdown on SIGINT/SIGTERM** | Production services need clean shutdown to avoid dropping in-flight auth requests. |
| **Exit code 1 for all errors** | Simple binary success/failure. Detailed errors written to stderr. |

---

## Public API

### Binary

```bash
nauts <command> [options]
```

### Subcommands

#### `auth`
**Purpose:** One-shot authentication. Authenticates a user and outputs a signed NATS user JWT to stdout.

**Usage:**
```bash
nauts auth -c <config-file> -token <json-token> [options]
```

**Flags:**

| Flag | Type | Default | Required | Description |
|------|------|---------|:--------:|-------------|
| `-c`, `--config` | string | `$NAUTS_CONFIG` | ✓ | Path to configuration JSON file |
| `-token` | string | — | ✓ | JSON authentication token (see format below) |
| `-user-pubkey` | string | — | ✗ | User's nkey public key (UABC...). If omitted, generates ephemeral key |
| `-ttl` | duration | `1h` | ✗ | JWT time-to-live (e.g., `30m`, `2h`, `1h30m`) |

**Environment Variables:**
- `NAUTS_CONFIG`: Fallback for `-c/--config` flag

**Token Format:**
```json
{
  "account": "APP",
  "token": "alice:secret",
  "ap": "local"
}
```
- `account`: required, target NATS account name
- `token`: required, provider-specific credential (e.g., `username:password` for file provider, JWT string for JWT provider)
- `ap`: optional, authentication provider id

**Output:**
- **Success:** JWT written to stdout (single line, no whitespace)
- **Error:** Error message written to stderr, exit code 1

**Examples:**
```bash
# File provider authentication
nauts auth -c nauts.json -token '{"account":"APP","token":"alice:secret"}'

# JWT provider authentication with custom TTL
nauts auth -c nauts.json \
  -token '{"account":"APP","token":"eyJhbGc...","ap":"keycloak"}' \
  -ttl 30m

# With explicit user public key
nauts auth -c nauts.json \
  -token '{"account":"APP","token":"alice:secret"}' \
  -user-pubkey UABC...
```

#### `serve`
**Purpose:** Run the NATS auth callout service. Subscribes to `$SYS.REQ.USER.AUTH` and handles authentication requests from the NATS server. Blocks until shutdown signal received.

**Usage:**
```bash
nauts serve -c <config-file>
```

**Flags:**

| Flag | Type | Default | Required | Description |
|------|------|---------|:--------:|-------------|
| `-c`, `--config` | string | `$NAUTS_CONFIG` | ✓ | Path to configuration JSON file |

**Environment Variables:**
- `NAUTS_CONFIG`: Fallback for `-c/--config` flag

**Signal Handling:**
- `SIGINT` (Ctrl+C): Graceful shutdown
- `SIGTERM`: Graceful shutdown

**Graceful Shutdown Sequence:**
1. Service receives signal
2. Subscription drained (no new requests accepted)
3. In-flight requests complete
4. NATS connection closed
5. Exit with code 0

**Output:**
- Startup messages to stderr
- Auth request logs to stderr (via configured logger)
- Shutdown message on signal

**Configuration Requirements:**
The `serve` command requires the `server` section in the config file:
```json
{
  "server": {
    "natsUrl": "nats://localhost:4222",
    "natsNkey": "auth-service.nk",
    "xkeySeedFile": "xkey.seed",
    "ttl": "1h"
  }
}
```

**Examples:**
```bash
# Start service with config file
nauts serve -c /etc/nauts/config.json

# Start with env var config path
export NAUTS_CONFIG=/etc/nauts/config.json
nauts serve

# Run with signal handling
nauts serve -c config.json  # Press Ctrl+C to stop gracefully
```

### Help Command

```bash
nauts help              # Print usage
nauts -h                # Print usage
nauts --help            # Print usage
nauts <command> -h      # Print command-specific help
```

---

## Configuration File

Both commands use the same JSON configuration format. See [auth-controller-callout spec](2026-02-06-auth-controller-callout.md) for complete config reference.

**Minimal static mode example:**
```json
{
  "account": {
    "type": "static",
    "static": {
      "publicKey": "ACONFIG...",
      "privateKeyPath": "issuer.nk",
      "accounts": ["APP"]
    }
  },
  "policy": {
    "type": "file",
    "file": {
      "policiesPath": "policies.json",
      "bindingsPath": "bindings.json"
    }
  },
  "auth": {
    "file": [
      { "id": "local", "accounts": ["APP"], "userPath": "users.json" }
    ]
  }
}
```

**For `serve` command, add:**
```json
{
  "server": {
    "natsUrl": "nats://localhost:4222",
    "natsCredentials": "auth.creds",
    "xkeySeedFile": "xkey.seed",
    "ttl": "1h"
  }
}
```

---

## Exit Codes

| Code | Meaning |
|:----:|---------|
| 0 | Success |
| 1 | Error (all error conditions) |

Detailed error information is written to stderr.

---

## Error Handling

**All errors result in:**
1. Descriptive message written to stderr
2. Exit code 1

**Error categories:**

| Error Type | Example Message |
|-----------|-----------------|
| Missing required flag | `error: -c/--config is required` |
| Config file error | `error: loading configuration: open nauts.json: no such file or directory` |
| Validation error | `error: creating auth controller: account.static.publicKey is required` |
| Authentication error | `error: authentication failed: invalid credentials` |
| Service startup error | `error: running callout service: failed to connect to NATS` |

**No error details leaked to clients:** The auth callout service returns generic errors to NATS clients (`"authentication failed"` or `"internal error"`). Full errors are logged server-side.

---

## Testing

### Manual Testing

**Test `auth` command:**
```bash
# Positive case
nauts auth -c test.json -token '{"account":"APP","token":"alice:secret"}'
# Should output JWT to stdout

# Negative case
nauts auth -c test.json -token '{"account":"APP","token":"wrong:password"}'
# Should print error to stderr and exit 1
```

**Test `serve` command:**
```bash
# Start service
nauts serve -c test.json &
SERVICE_PID=$!

# Test with NATS client
nats --token '{"account":"APP","token":"alice:secret"}' pub test "hello"

# Stop service
kill -TERM $SERVICE_PID
```

### Integration Tests

The `e2e/` tests cover CLI behavior:
- `connection_test.go`: Tests full CLI + NATS server integration
- Verifies both `auth` and `serve` commands
- Tests static and operator modes

---

## Known Limitations / Future Work

- **No interactive mode:** Token must be provided as a command-line flag. Interactive password prompt not supported.
- **No config validation command:** No `nauts validate-config` subcommand to check config files without running authentication.
- **No version command:** No `nauts version` to print build information.
- **No daemon management:** No built-in process management (use systemd, docker, or similar).
- **No log levels:** Logging verbosity not configurable via CLI flags (uses default logger).
- **No health check command:** No `nauts health` to check if service is responding.
- **Single config file:** Cannot merge multiple config files or override individual settings via flags.

---

## Future Enhancements

| Enhancement | Priority | Description |
|------------|:--------:|-------------|
| `validate-config` command | Medium | Validate config file without starting service |
| `version` command | Low | Print version and build information |
| `health` command | Low | Check service health via NATS connection |
| Log level flags | Low | Add `-v/--verbose` and `-q/--quiet` flags |
| Config overrides | Low | Allow flag-based override of config values (e.g., `--server.ttl=30m`) |
| Interactive auth | Low | Prompt for credentials instead of requiring `-token` flag |

---

## See Also

- [Auth Controller & Callout Service Spec](2026-02-06-auth-controller-callout.md) - Configuration format and service behavior
- [System Overview](2026-02-06-system-overview.md) - Architecture and deployment modes
- [e2e/README.md](../e2e/README.md) - End-to-end testing documentation
